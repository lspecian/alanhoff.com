<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Blog pessoal sobre JavaScript, Node.js, AngularJs, sistemas embarcados e outras cachaças.">
  <meta name="author" content="Alan Hoffmeister <alanhoffmeister@gmail.com>">

  <title>Alan Hoffmeister - Renderizando com dust.js no Express</title>

  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://alanhoff.com/rss.xml">

  <!-- Fonts -->
  <link href="//fonts.googleapis.com/css?family=Source+Sans+Pro%3A400%2C400italic%2C700" rel="stylesheet">
  <link href="//fonts.googleapis.com/css?family=Varela+Round" rel="stylesheet">

  <!-- Bootstrap core CSS -->
  <link href="/assets/css/bootstrap.min.css" rel="stylesheet">
  <link href="/assets/css/font-awesome.min.css" rel="stylesheet">
  <link href="/assets/css/bootstrap-social.css" rel="stylesheet">

  <!-- Styles -->
  <link href="/assets/css/main.css" rel="stylesheet">
  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/monokai_sublime.min.css">


</head>


  <body>

    <div id="primary" class="col-sm-12">
      <div class="content">
      <a href="https://github.com/alanhoff/alanhoff.com"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/a6677b08c955af8400f44c6298f40e7d19cc5b2d/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677261795f3664366436642e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png"></a>

        <header class="header">
          <hgroup class="pull-left">
            <h1 class="site-title">
              
              <a rel="home" title="Alan Hoffmeister" href="/">
                <i class="fa fa-newspaper-o"></i> Alan Hoffmeister
              </a>
              
            </h1>
          </hgroup>
          <a href="https://alanhoff.com/rss.xml" class="btn btn-primary pull-right">
            <i class="fa fa-rss"></i>
          </a>
        </header> <!-- /header -->

        

  
  <section class="post">
    <header class="entry-header">
      <img class="entry-avatar" alt="Paul Laros" height="52" width="52" src="//www.gravatar.com/avatar/6350d3781efe9d1a3a88542771ee39d4.jpg?s=52">
      <h1 class="entry-title"><a href="posts/renderizando-dust-js-no-express.html">Renderizando com dust.js no Express</a></h1>
      <p class="entry-meta">
        Postado em 2014-10-21 22:00 | Por <a class="entry-author" href="https://twitter.com/alan_hoff">Alan Hoffmeister</a>
      </p>
    </header>
    <div class="entry-description">
        <p>Uma das coisas mais básicas que um sistema web pode fazer é renderizar uma
página HTML para ser exibida no navegador do seu usuário. Embora essa seja
uma tarefa trivial, muitos recém chegados podem ter uma certa dificuldade de
achar a melhor ferramenta de renderização para o seu projeto.<!--more--> Hoje
vamos falar sobre uma delas, o <a href="https://linkedin.github.io/dustjs">dust.js</a>, em especial o
<a href="http://engineering.linkedin.com/frontend/client-side-templating-throwdown-mustache-handlebars-dustjs-and-more">fork criado pela LinkedIn</a>.</p>
<h3 id="um-pouco-sobre-o-dust-js">Um pouco sobre o dust.js</h3>
<p>O dust.js foi desenvolvido originalmente por <a href="https://github.com/akdubya">Aleksander Williams</a>, este
módulo se destaca dos <a href="http://node-modules.com/search?q=template">demais templates engines</a> por ser assíncrono por
natureza e stream do template para o cliente enquanto ainda está sendo gerado.
Por exemplo, com esse helper abaixo, consigo demonstrar a natureza assíncrona
deste template engine.</p>
<pre><code class="lang-javascript">dust.makeBase({
    asyncHello : function(chunk){
        // Informamos que o processo é assíncrono
        chunk.map(function(chunk){

            // Depois de um segundo escrevemos uma frase
            // no chunk que recebemos
            setTimeout(function(){
                chunk.write(&#39;Hello async world!&#39;);

                // Precisamos informar que terminamos
                // nossas operações assíncronas e o dust.js
                // pode seguir seu trabalho
                chunk.end();
            }, 1000);
        });
    }
});
</code></pre>
<p>Com nosso helper registrado so é necessário chamá-lo no seu template:</p>
<pre><code class="lang-html">&lt;h1&gt;{asyncHello}&lt;/h1&gt;

&lt;!-- Será renderizado para --&gt;
&lt;h1&gt;Hello async world!&lt;/h1&gt;
</code></pre>
<p>Com isso podemos deixar o carregamento de dados dinâmico, sem precisar carregar
todos os dados na rota antes de chamar a renderização, assim podemos ter
templates dinâmicos que não dependem da rota para carregar determinada
informação. Quem já trabalha com server side templates no Node.js sabe muito
bem o problema que muitas vezes isso pode causar.</p>
<h3 id="express-e-adaro">Express e Adaro</h3>
<p>Esse post terá o <a href="http://expressjs.com">Express</a> como gerenciador de rotas da nossa aplicação e o
pacote <a href="https://github.com/krakenjs/adaro">Adaro</a> que ajudará a plugar o Dust.js no Express. O pacote
<a href="https://github.com/mikeal/request">request</a> servirá como uma ajuda na hora de construir o helper <code>gists</code>,
responsável por listar gists de um determinado usuário.</p>
<p>Começaremos criando um diretório e instalando os pacotes necessários:</p>
<pre><code class="lang-bash">mkdir teste-dust
cd teste-dust
mkdir template
npm init
# Respoder as perguntas
npm install --save express adaro dustjs-helpers dustjs-linkedin request
</code></pre>
<p>Com a nossa pasta pronta, já podemos começar o código:</p>
<pre><code class="lang-javascript">// Começamos com o require dos pacotes importantes
// para o projeto
var request = require(&#39;request&#39;);
var express = require(&#39;express&#39;);
var app = express();
var dustjs = require(&#39;adaro&#39;);

// Setando opções padrões para o request
var r = request.defaults({
    headers: {
        &#39;User-Agent&#39;: &#39;Node.js&#39;
    }
});

// Usando a api do Express, cadastramos uma nova engine
// e desabilitamos o cache pois estamos em modo de desenvolvimento
app.engine(&#39;dust&#39;, dustjs.dust({
    cache: false
}));

// Setamos algumas variáveis, como a engine responsável
// por renderizar, desabilitamos o cache do Express e
// setamos o diretório onde estão guardadas nossas views
app.set(&#39;view engine&#39;, &#39;dust&#39;);
app.set(&#39;view cache&#39;, &#39;false&#39;);
app.set(&#39;views&#39;, __dirname + &#39;/template&#39;);

// Setamos a nossa primeira rota, onde renderizamos
// o index.dust e passamos algumas variáveis para o template
app.get(&#39;/&#39;, function(req, res){
    res.render(&#39;index&#39;, {
        pessoas: [
            {nome: &#39;Alan&#39;, sobrenome: &#39;Hoffmeister&#39;},
            {nome: &#39;John&#39;, sobrenome: &#39;Levitt&#39;},
            {nome: &#39;Lorem&#39;, sobrenome: &#39;Ipsum&#39;}
        ],
        gists: function(chunk, context, bodies, params){

            // Estamos dizendo que esse chunk, ou parte do
            // template que está usando o #gists, é assíncrono
            return chunk.map(function(chunk){
                var url = &#39;https://api.github.com/users/&#39; +
                    params.user + &#39;/gists&#39;;

                // Vamos buscar na API do GitHub os últimos
                // gists do usuário que foi configurado no
                // tag do template
                r.get(url, function(err, headers, body){
                    var json = JSON.parse(body);

                    // Para cada gist encontrado, temos que renderizar
                    // o bloco, enviarmos o gist como o contexto do bloco,
                    // assim poder usar o json do gist como marcação no
                    // template
                    json.forEach(function(repo){
                        chunk.render(bodies.block, context.push(repo));
                    });

                    chunk.end();
                });
            });
        }
    });
});

// Uma segunda rota onde vamos renderizar a nossa pseudo página
// de contato
app.get(&#39;/contato&#39;, function(req, res){
    res.render(&#39;contato&#39;);
});

// Essa rota será acionada sempre que o Express detectar uma
// requisição que está pedidindo por uma rota não cadastrada,
// nessa caso específico usaremos para detectar páginas que não
// existem.
app.all(&#39;*&#39;, function(req, res){
    res.status(404).render(&#39;404&#39;);
});

// Iniciamos o Express na porta 8080
app.listen(8080);
</code></pre>
<h3 id="templates">Templates</h3>
<p>Os templates estão disponíveis <a href="https://github.com/alanhoff/alanhoff.com-dust">neste repositório</a> dentro da pasta
<code>template</code>, tudo o que você precisa fazer é copiar os arquivos para a pasta que
criamos anteriormente. Não vou postar aqui pois o intuito desta postagem não é
demonstrar o markup do Dust.js mas sim suas facilidades e integração.</p>
<h3 id="conclus-o">Conclusão</h3>
<p>Escrever um helper para o Dust.js pode não ser a coisa mais fácil do mundo,
pois a natureza da própria plataforma Node.js anceia por métodos assíncronos, e
são esses métodos que tornam essa template engine extremamente performática e
modular, perfeita para o seu próximo projeto em Node.js.</p>

    </div>
  </section>

  <div class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'alanhoffmeister'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
  </div>


        <footer class="footer">
          <p>Conteúdo sob <a href="https://pt.wikipedia.org/wiki/Licen%C3%A7a_ISC">licença ISC</a>. 2014 - Alan Hofmeister</p>
          <div class="socials-footer">
            <a class="btn btn-facebook" href="https://www.facebook.com/alan.hoffmeister" title="Facebook">
              <i class="fa fa-facebook"></i>
            </a>
            <a class="btn btn-twitter" href="https://twitter.com/alan_hoff" title="Twitter">
              <i class="fa fa-twitter"></i>
            </a>
            <a class="btn btn-linkedin" href="http://br.linkedin.com/in/alanhoff" title="LinkedIn">
              <i class="fa fa-linkedin"></i>
            </a>
            <a class="btn btn-google-plus" href="https://plus.google.com/+alanhoffmeister" title="Google+">
              <i class="fa fa-google-plus"></i>
            </a>
            <a class="btn btn-github" href="https://github.com/alanhoff" title="GitHub">
              <i class="fa fa-github"></i>
            </a>
            <a class="btn btn-bitbucket" href="https://bitbucket.org/alanhoff" title="Bitbucket">
              <i class="fa fa-bitbucket"></i>
            </a>
          </div> <!-- /.socials-footer -->
        </footer> <!-- /footer -->

      </div>
    </div> <!-- /#primary -->

    <!-- Scripts -->
    <script src="/assets/js/jquery-1.11.0.min.js"></script>
    <script src="/assets/js/bootstrap.min.js"></script>
    
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
<script type="text/javascript">
  $('code').each(function(){
    var el = $(this);
    var content = el.text();
    var lang = el.attr('class') || '';
    lang = lang.indexOf('lang-') === 0 ? lang.substring(5) : 'html';
    el.html(hljs.highlight(lang, content).value);
  });
</script>


  </body>
</html>
